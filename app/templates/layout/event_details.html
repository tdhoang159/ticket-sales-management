{% extends 'layout/base.html' %}
{% block content%}
<h1 class="text-center text-success mt-2">CHI TIẾT SỰ KIỆN</h1>
<div class="row">
    <div class="col-md-5 col-6">
        <img src="{{ event.banner }}" class="img-fluid rounded"/>
    </div>
    <div class="col-md-7 col-6">
        <h1 class="text-center">{{ event.name }}</h1>
        <h5>{{ event.description }}</h5>
        <p class="fw-bold text-primary fs-5">
            ⏰ Thời gian tổ chức lúc {{ event.datetime.strftime("%H:%M") }} -
            ngày {{ event.datetime.strftime("%d/%m/%Y") }}
        </p>
        <p><strong>Ban tổ chức:</strong> {{ event.organizer.company_name }}</p>
        <p><strong>Địa chỉ tổ chức:</strong> {{ event.address_detail }}</p>
        <p><strong>Tỉnh/ Thành phố:</strong> {{ event.province }}</p>

        {% if event.vip_quantity > 0 %}
        <p class="text-danger fw-bold fs-5"><strong>Số lượng vé VIP còn: {{ event.vip_quantity }}</strong></p>
        {% else %}
        <p class="text-danger fw-bold fs-5"><strong>Đã hết vé VIP</strong></p>
        {% endif %}

        {% if event.normal_quantity > 0 %}
        <p class="text-danger fw-bold fs-5"><strong>Số lượng vé THƯỜNG còn: {{ event.normal_quantity }}</strong></p>
        {% else %}
        <p class="text-danger fw-bold fs-5"><strong>Đã hết vé THƯỜNG</strong></p>
        {% endif %}

        <div class="mt-3">
            <!-- Vé thường -->
            <div class="d-flex align-items-center mb-2">
                <label for="normal_quantity" class="fw-bold me-2">
                    Vé thường ({{ "{:,.0f}".format(event.normal_price) }} VND):
                </label>
                <input type="number" id="normal_quantity" class="form-control w-auto"
                       min="0" max="{{ event.normal_quantity }}" value="0"
                       {% if event.normal_quantity == 0 %}disabled{% endif %}>
            </div>

            <!-- Vé VIP -->
            <div class="d-flex align-items-center mb-2">
                <label for="vip_quantity" class="fw-bold me-2">
                    Vé VIP ({{ "{:,.0f}".format(event.vip_price) }} VND):
                </label>
                <input type="number" id="vip_quantity" class="form-control w-auto"
                       min="0" max="{{ event.vip_quantity }}" value="0"
                       {% if event.vip_quantity == 0 %}disabled{% endif %}>
            </div>
            <!-- Thông báo lỗi đặt vé -->
            <div id="ticket_error" class="alert alert-danger text-center fw-bold" style="display:none;"></div>
            <!-- Tổng vé & tiền -->
            <div id="summary" class="mt-2 fw-bold text-danger" style="display:none;">
                <p>Tổng số vé: <span id="total_tickets">0</span></p>
                <p>Tổng số tiền: <span id="total_price">0</span> VNĐ</p>
            </div>
        </div>

        <div class="text-center mt-3 w-75 mx-auto">
            {% if event.vip_quantity == 0 and event.normal_quantity == 0 %}
            <div class="alert alert-danger fw-bold text-center">
                Đã bán hết vé, vui lòng chọn sự kiện khác!
            </div>
            {% else %}
            <button
                    class="btn btn-danger"
                    onclick="handleAddToCart(
                    {{ event.id }},
                    '{{ event.name }}',
                    {{ event.vip_price }},
                    {{ event.normal_price }})"
            >
                Đặt vé
            </button>
            {% include "layout/notify_put_ticket_in_cart_modal.html" %}
            {% endif %}
        </div>
    </div>
</div>
{% if current_user.is_authenticated %}
<div class="text-end mt-3 w-75 mx-auto">
    <div id="comment_error" class="alert alert-danger text-start fw-bold text-center" style="display:none;"></div>
    <textarea class="form-control" rows="5" id="comment" placeholder="Nội dung bình luận..."></textarea>
    <button class="btn btn-success fw-bold mt-3 me-7" onclick="handleAddComment({{ event.id }})">Bình luận</button>
</div>
{% else %}
<div class="text-end mt-3 w-75 mx-auto">
    <button class="btn btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#loginRequiredCommentModal">
        Bình luận
    </button>
</div>
{% include "layout/login_required_comment_modal.html" %}
{% endif %}
<ul class="list-group mt-3" id="comments">
    {% for c in comments %}
    <li class="list-group-item w-75 mx-auto">
        <div class="row">
            <div class="col-md-1 col-4">
                <img src="{{ c.user.avatar }}" class="img-fluid rounded-circle w-75 mx-auto d-block"/>
                <p class="fw-bold text-center">{{ c.user.username }}</p>
            </div>
            <div class="col-md-11 col-8">
                <p>{{ c.content }}</p>
                <p class="date small fst-italic text-muted">{{ c.created_date }}</p>
            </div>
        </div>
    </li>
    {% endfor %}
</ul>
<script>
    window.onload = function() {
        let dates = document.getElementsByClassName("date");
        for (let d of dates)
            d.innerText = moment(d.innerText).locale("vi").fromNow();
    }

    const normalPrice = {{ event.normal_price }};
    const vipPrice = {{ event.vip_price }};

    const normalInput = document.getElementById("normal_quantity");
    const vipInput = document.getElementById("vip_quantity");
    const summaryDiv = document.getElementById("summary");
    const totalTicketsSpan = document.getElementById("total_tickets");
    const totalPriceSpan = document.getElementById("total_price");

    function updateSummary() {
        let normalQty = parseInt(normalInput.value) || 0;
        let vipQty = parseInt(vipInput.value) || 0;

        let totalTickets = normalQty + vipQty;
        let totalPrice = (normalQty * normalPrice) + (vipQty * vipPrice);

        if (totalTickets > 0) {
            summaryDiv.style.display = "block";
            totalTicketsSpan.innerText = totalTickets;
            totalPriceSpan.innerText = totalPrice.toLocaleString("vi-VN");
        } else {
            summaryDiv.style.display = "none";
        }
    }

    normalInput.addEventListener("input", updateSummary);
    vipInput.addEventListener("input", updateSummary);

    window.onpageshow = function(event) {
    if (event.persisted) {
        let modal = document.getElementById("notifyPutTicketInCartModal");
        let modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    }
};

    function handleAddToCart(id, name, vip_price, normal_price) {
    const normalQty = parseInt(document.getElementById('normal_quantity').value) || 0;
    const vipQty = parseInt(document.getElementById('vip_quantity').value) || 0;
    const errorDiv = document.getElementById('ticket_error');

    if (normalQty <= 0 && vipQty <= 0) {
        errorDiv.innerText = "Vui lòng chọn ít nhất 1 vé VIP hoặc vé thường!";
        errorDiv.style.display = "block";
        return;
    }

    // Ẩn lỗi nếu hợp lệ
    errorDiv.style.display = "none";
    add_to_cart(id, name, vip_price, normal_price, normalQty, vipQty);

    // Mở modal notify_put_ticket_in_cart_modal.html
    const modalEl = document.getElementById('notifyPutTicketInCartModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

function handleAddComment(eventId) {
    const content = document.getElementById('comment').value.trim();
    const errorDiv = document.getElementById('comment_error');

    if (!content) {
        errorDiv.innerText = "Vui lòng nhập nội dung bình luận!";
        errorDiv.style.display = "block";
        return;
    }

    // Ẩn lỗi nếu hợp lệ
    errorDiv.style.display = "none";

    addComment(eventId);
}
</script>
{% endblock %}