{% extends 'layout/base.html' %}
{% block content%}
<h1 class="text-center text-success mt-1">CHI TIẾT SỰ KIỆN</h1>
<div class="row">
    <div class="col-md-5 col-6">
        <img src="{{ event.banner }}" class="img-fluid rounded"/>
    </div>
    <div class="col-md-7 col-6">
        <h1 class="text-center">{{ event.name }}</h1>
        <h5>{{ event.description }}</h5>
        <p class="fw-bold text-danger">
            ⏰ Thời gian tổ chức lúc {{ event.datetime.strftime("%H:%M") }} -
            ngày {{ event.datetime.strftime("%d/%m/%Y") }}
        </p>
        <p><strong>Ban tổ chức:</strong> {{ event.organizer }}</p>
        <p><strong>Địa chỉ tổ chức:</strong> {{ event.address_detail }}</p>
        <p><strong>Tỉnh/ Thành phố:</strong> {{ event.province }}</p>

        <div class="mt-3">
            <!-- Vé thường -->
            <div class="d-flex align-items-center mb-2">
                <label for="normal_quantity" class="fw-bold me-2">
                    Vé thường ({{ "{:,.0f}".format(event.normal_price) }} VND):
                </label>
                <input type="number" id="normal_quantity" class="form-control w-auto"
                       min="0" max="{{ event.normal_quantity }}" value="0">
            </div>

            <!-- Vé VIP -->
            <div class="d-flex align-items-center mb-2">
                <label for="vip_quantity" class="fw-bold me-2">
                    Vé VIP ({{ "{:,.0f}".format(event.vip_price) }} VND):
                </label>
                <input type="number" id="vip_quantity" class="form-control w-auto"
                       min="0" max="{{ event.vip_quantity }}" value="0">
            </div>

            <!-- Tổng vé & tiền -->
            <div id="summary" class="mt-2 fw-bold text-danger" style="display:none;">
                <p>Tổng số vé: <span id="total_tickets">0</span></p>
                <p>Tổng số tiền: <span id="total_price">0</span> VNĐ</p>
            </div>
        </div>

        <div class="text-center mt-3 w-75 mx-auto">
            <button
                    class="btn btn-danger"
                    onclick="add_to_cart(
                    {{ event.id }},
                    '{{ event.name }}',
                    {{ event.vip_price }},
                    {{ event.normal_price }},
                    parseInt(document.getElementById('normal_quantity').value) || 0,
                    parseInt(document.getElementById('vip_quantity').value) || 0)"
                    data-bs-toggle="modal"
                    data-bs-target="#notifyPutTicketInCartModal"
            >
                Đặt vé
            </button>
            {% include "layout/notify_put_ticket_in_cart_modal.html" %}
        </div>
    </div>
</div>
{% if current_user.is_authenticated %}
<div class="text-end mt-3 w-75 mx-auto">
    <textarea class="form-control" rows="5" id="comment" placeholder="Nội dung bình luận..."></textarea>
    <button class="btn btn-success fw-bold mt-3 me-7" onclick="addComment({{ event.id }})">Bình luận</button>
</div>
{% else %}
<div class="text-end mt-3 w-75 mx-auto">
    <button class="btn btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#loginRequiredCommentModal">
        Bình luận
    </button>
</div>
{% include "layout/login_required_comment_modal.html" %}
{% endif %}
<ul class="list-group mt-3" id="comments">
    {% for c in comments %}
    <li class="list-group-item w-75 mx-auto">
        <div class="row">
            <div class="col-md-1 col-4">
                <img src="{{ c.user.avatar }}" class="img-fluid rounded-circle w-75 mx-auto d-block"/>
                <p class="fw-bold text-center">{{ c.user.username }}</p>
            </div>
            <div class="col-md-11 col-8">
                <p>{{ c.content }}</p>
                <p class="date small fst-italic text-muted">{{ c.created_date }}</p>
            </div>
        </div>
    </li>
    {% endfor %}
</ul>
<script>
    window.onload = function() {
        let dates = document.getElementsByClassName("date");
        for (let d of dates)
            d.innerText = moment(d.innerText).locale("vi").fromNow();
    }

    const normalPrice = {{ event.normal_price }};
    const vipPrice = {{ event.vip_price }};

    const normalInput = document.getElementById("normal_quantity");
    const vipInput = document.getElementById("vip_quantity");
    const summaryDiv = document.getElementById("summary");
    const totalTicketsSpan = document.getElementById("total_tickets");
    const totalPriceSpan = document.getElementById("total_price");

    function updateSummary() {
        let normalQty = parseInt(normalInput.value) || 0;
        let vipQty = parseInt(vipInput.value) || 0;

        let totalTickets = normalQty + vipQty;
        let totalPrice = (normalQty * normalPrice) + (vipQty * vipPrice);

        if (totalTickets > 0) {
            summaryDiv.style.display = "block";
            totalTicketsSpan.innerText = totalTickets;
            totalPriceSpan.innerText = totalPrice.toLocaleString("vi-VN");
        } else {
            summaryDiv.style.display = "none";
        }
    }

    normalInput.addEventListener("input", updateSummary);
    vipInput.addEventListener("input", updateSummary);

    window.onpageshow = function(event) {
    if (event.persisted) {
        let modal = document.getElementById("notifyPutTicketInCartModal");
        let modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    }
};
</script>
{% endblock %}